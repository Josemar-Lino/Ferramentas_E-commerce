<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Visualizar e Imprimir Etiquetas ZPL</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            automax: {
              red: '#b22222',
              dark: '#343a40',
              light: '#f8f9fa'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-automax-light min-h-screen p-6">

  <h2 class="text-3xl font-bold text-center text-automax-red mb-6">
    Carregar ZIP com arquivos .txt (ZPL) e visualizar etiquetas
  </h2>

  <div class="flex flex-col items-center gap-4 mb-6">
    <input type="file" id="zipInput" accept=".zip" class="p-2 border rounded shadow w-80" />
    <button id="printAll" class="bg-automax-red text-white px-4 py-2 rounded hover:bg-red-800 transition hidden">
      Imprimir Todas as Etiquetas
    </button>
  </div>

  <div id="output" class="flex flex-col gap-6 max-h-[70vh] overflow-y-auto"></div>

  <script>
    const zipInput = document.getElementById('zipInput');
    const output = document.getElementById('output');
    const printAllBtn = document.getElementById('printAll');
    let allImageUrls = [];

    const widthInches = 3.93701;
    const heightInches = 5.51181;
    const heightApiRequest = 6.0;
    const heightPrintWithMargin = heightInches + 0.1;

    zipInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      allImageUrls.forEach(url => URL.revokeObjectURL(url));
      allImageUrls = [];
      output.innerHTML = "<p class='text-gray-600'>Carregando arquivo ZIP...</p>";
      printAllBtn.classList.add('hidden');
      zipInput.disabled = true;

      try {
        const zip = await JSZip.loadAsync(file);
        const txtFiles = Object.keys(zip.files).filter(f => f.endsWith('.txt'));
        if (txtFiles.length === 0) {
          output.innerHTML = "<p class='text-red-500'>Nenhum arquivo .txt encontrado no ZIP.</p>";
          zipInput.disabled = false;
          return;
        }
        output.innerHTML = '';

        for (const filename of txtFiles) {
          const fileData = zip.files[filename];
          const content = await fileData.async('string');
          const zplBlocks = content.split('^XZ').map(p=>p.trim()).filter(p=>p.startsWith('^XA')).map(p=>p+'^XZ');

          for (let i=0;i<zplBlocks.length;i++) {
            const zpl = zplBlocks[i];
            const container = document.createElement('div');
            container.className = 'bg-white rounded-lg p-4 shadow flex flex-col items-center';
            container.innerHTML = `
              <h3 class="font-semibold mb-2">${filename} - Etiqueta ${i+1}</h3>
              <div class="image-container w-full flex justify-center items-center h-64 mb-2 text-gray-500">Gerando etiqueta...</div>
              <div class="flex gap-2">
                <button class="print-btn hidden bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Imprimir</button>
                <a class="download-link hidden bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Baixar imagem</a>
              </div>
            `;
            output.appendChild(container);

            const btnPrint = container.querySelector('.print-btn');
            const downloadLink = container.querySelector('.download-link');
            const imgContainer = container.querySelector('.image-container');
            let imgUrl = '';

            try {
              const response = await fetch(`https://api.labelary.com/v1/printers/8dpmm/labels/${widthInches}x${heightApiRequest}/0/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: zpl
              });
              if (!response.ok) throw new Error('Erro ao gerar imagem da etiqueta.');
              const blob = await response.blob();
              imgUrl = URL.createObjectURL(blob);
              allImageUrls.push(imgUrl);

              imgContainer.innerHTML = `<img src="${imgUrl}" class="max-h-full object-contain"/>`;
              btnPrint.classList.remove('hidden');
              downloadLink.classList.remove('hidden');
              downloadLink.href = imgUrl;
              downloadLink.download = `${filename.replace('.txt','')}_etiqueta${i+1}.png`;

              btnPrint.onclick = () => {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                  <html>
                    <head>
                      <title>Etiqueta</title>
                      <style>
                        @media print {
                          @page { size: ${widthInches}in ${heightPrintWithMargin}in; margin:0; }
                          img { width:${widthInches}in; max-height:${heightPrintWithMargin}in; object-fit: scale-down; display:block; margin:0 auto; page-break-inside: avoid; }
                          body { margin:0; padding:0; background:white; text-align:center;}
                        }
                      </style>
                    </head>
                    <body>
                      <img src="${imgUrl}" />
                      <script>
                        window.onload = function() {
                          window.print();
                        };
                        window.onafterprint = function() {
                          window.close();
                        };
                      <\/script>
                    </body>
                  </html>
                `);
                printWindow.document.close();
              };

            } catch(err){
              imgContainer.innerHTML = `<p class="text-red-500">Erro: ${err.message}</p>`;
            }
          }
        }

        if (allImageUrls.length > 0) {
          printAllBtn.classList.remove('hidden');
        }

      } catch(e) {
        output.innerHTML = `<p class='text-red-500'>Erro ao processar o arquivo ZIP: ${e.message}</p>`;
      } finally {
        zipInput.disabled = false;
      }
    });

    printAllBtn.onclick = () => {
      if (allImageUrls.length === 0) return;
      const printWindow = window.open('', '_blank');
      const imgTags = allImageUrls.map(url=>`<img src="${url}" style="width:${widthInches}in; max-height:${heightPrintWithMargin}in; object-fit: scale-down; display:block; margin:0 auto; page-break-inside: avoid;"/>`).join('');
      printWindow.document.write(`
        <html>
          <head>
            <title>Imprimir Etiquetas</title>
            <style>
              @media print {
                @page { size:${widthInches}in ${heightPrintWithMargin}in; margin:0; }
                img { width:${widthInches}in; max-height:${heightPrintWithMargin}in; object-fit: scale-down; display:block; margin:0 auto; page-break-inside: avoid; }
                body { margin:0; padding:0; background:white; text-align:center;}
              }
            </style>
          </head>
          <body>
            ${imgTags}
            <script>
              window.onload = function() {
                window.print();
              };
              window.onafterprint = function() {
                window.close();
              };
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    };
  </script>
</body>
</html>
